---
import { getCardForDate } from "../utils/getCardForDate";
import "../styles/global.css";

const today = new Date();
const card = getCardForDate(today);

const dayName = today.toLocaleDateString("en-GB", { weekday: "short" });
const dateDisplay = today.toLocaleDateString("en-GB", {
  day: "2-digit",
  month: "short",
});

const fixedWeekDays = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];

interface DayInfo {
  label: string;
  dateNum: string;
  inRange: boolean;
  isToday: boolean;
}

let weekGrid: DayInfo[] = [];
let weekNumberPart = "";
let weekRangePart = "";

if (card.weekStart && card.weekEnd && card.weekNumber) {
  weekNumberPart = `Week ${card.weekNumber} / 52`;

  const startDate = new Date(card.weekStart);
  startDate.setDate(startDate.getDate() - startDate.getDay()); // Sunday before or on weekStart

  const endDate = new Date(startDate);
  endDate.setDate(startDate.getDate() + 20); // 21 days total

  weekRangePart = `${card.weekStart.toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
  })} â€“ ${card.weekEnd.toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
  })}`;

  for (let i = 0; i < 21; i++) {
    const day = new Date(startDate);
    day.setDate(startDate.getDate() + i);

    const inRange = day >= card.weekStart && day <= card.weekEnd;
    const isToday = day.toDateString() === today.toDateString();

    weekGrid.push({
      label: fixedWeekDays[day.getDay()],
      dateNum: String(day.getDate()).padStart(2, "0"),
      inRange,
      isToday,
    });
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <title>Poker Calendar</title>
  </head>
  <body>
    <main class="centered">
      <div class="clock">
        <div class="date">{dayName} {dateDisplay}</div>
        <div id="time" class="time">-- --</div>
      </div>

      <div class="cal">
        <div class="week-number">
          <strong>{weekNumberPart}</strong>: <span class="week-range"
            >{weekRangePart}</span
          >
        </div>

        <div class="week-grid">
          {
            weekGrid.slice(0, 7).map((day) => {
              const isWeekend = day.label === "sun" || day.label === "sat";
              return (
                <div
                  class={`week-cell week-label ${isWeekend ? "weekend" : ""}`}
                >
                  {day.label}
                </div>
              );
            })
          }
          {
            weekGrid.map((day) => (
              <div
                class={`week-cell ${!day.inRange ? "out-of-range" : ""} ${day.isToday ? "today" : ""}`}
              >
                {day.dateNum}
              </div>
            ))
          }
        </div>
      </div>

      <div class="card-suit">
        {card.rank} of {card.suit}
        <span class={`suit ${card.suit?.toLowerCase()}`}>{card.suitSymbol}</span
        >
      </div>
    </main>

    <script is:inline>
      function updateClock() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, "0");
        const m = String(now.getMinutes()).padStart(2, "0");
        const timeEl = document.getElementById("time");
        if (timeEl) {
          timeEl.textContent = h + ":" + m;
        }
      }

      updateClock();
      setInterval(updateClock, 10_000);
    </script>
  </body>
</html>
